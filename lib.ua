# Experimental!

â”Œâ”€â•´FFI ~ Call Lib
  LibPath â† "/lib/libsqlite3.so"
  # result ? function params
  Lib â† &ffi âŠ‚â–¡LibPath
  # result ? return-type name param-types params
  Call â† Lib âŠ‚â–¡â‚‚

  P â† $"_*"
  C â† $"const _"

  ğ•” â† "char"
  â„ â† "double"
  â„¤ â† "int"
  ğ•§ â† "void"
â””â”€â•´

SqliteOk   â† 0
SqliteRow  â† 100
SqliteDone â† 101

~Statement {Stmt DB}

IsNull  â† â‰NaN
IsInt   â† â¨¬(0|â‰âŠ¸â…)â†§âŠ¸âŠƒ(=0type|â‰[]â–³)
IsFloat â† â¨¬(0|Â¬â‰âŠ¸â…)â†§âŠ¸âŠƒ(=0type|â‰[]â–³)
IsText  â† â†§âŠƒ(=2type|=1â§»â–³)
IsBlob  â† â¨¬(0|/â†§â‰¤255)â†§âŠ¸âŠƒ(=0type|=1â§»â–³)

InferType â† â£(
  âŠ¢âŠš[âŠƒ(IsNull|IsInt|IsFloat|IsText|IsBlob)]
| â¤."Invalid value"â—Œ)

# https://www.sqlite.org/c3ref/errcode.html
Err â† Lib FFI!{C P ğ•” "sqlite3_errmsg" C P â„¤} â–¡â‚

Err! â† â¨¬(â¤.^0 Err|â—Œ)â‰SqliteOk

# https://www.sqlite.org/c3ref/open.html
Open â† FFI!(
  âœâ–¡â‚‚(Call â„¤ "sqlite3_open" {C P ğ•” P P ğ•§}) âŠ™0
  â¤$"Failed to open database: _"â¤™â‰SqliteOk
)

# https://www.sqlite.org/c3ref/close.html
Close â† FFI!(
  Call â„¤ "sqlite3_close" {C P ğ•§} â–¡â‚ .
  Err!$"Failed to close database: _"
)

# Should be used like `âœConnectionâŸœF`.
# Inside F, you have access to the database
# pointer. `âŸœ` ensures that the pointer
# ends up on top of the stack to close
# the connection.
Connection â† âŒ…(Open|Close)

# creates a new macro "<name>!"
# which executes a function inside a database
# connection to a database named like whatever
# is given to the macro. need to improve this
DB! â†^ (
  â—‡âŠ¸âœâŠ¢âŒµâŠ¢
  $$ # Call some code inside a database connection
  $$ _! â† âœUiqlite~ConnectionâŸœ^0 "_"
)

# https://www.sqlite.org/c3ref/exec.html
Exec â† FFI!(
  â–¡â‚… âŠ“:(0 0 "www")
  Call â„¤ "sqlite3_exec" {C P ğ•§ C P ğ•” C P ğ•§ C P ğ•§ C P P ğ•”}
  â¨¬(â¤.$"Failed to exec: _"|â—Œ)â‰SqliteOk Â°â–¡â‚‚
)

# https://www.sqlite.org/c3ref/prepare.html
# prepared ? str db*
Prepare â† FFI!(
  â–¡â‚…âŠƒâŠ“:(Â¯1 0 0)â¤™â—Œ
  Call â„¤ "sqlite3_prepare_v2" {C P ğ•§ C P ğ•” â„¤ P P ğ•§ C P P ğ•”}
  â¨¬(â¤.$"Failed to prepare statement: _" Err:|âŠ™â—Œ)â‰SqliteOk âˆ©Â°â–¡âŠ¢â‚‚
  Statement
)

# https://www.sqlite.org/c3ref/bind_blob.html
BindBlob â† FFI!(
  # TODO: This doesn't work, no idea why
  â–¡â‚… âŠƒ(â‹…â‹…Statement~Stmt|âŠ™âˆ˜|â‹…â§»|NULL|â‹…â‹…Statement~DB)
  Call â„¤ "sqlite3_bind_blob" {C P ğ•§ C â„¤ C P â„¤ C â„¤ C P ğ•§}
  Err!$"Failed to bind blob: _"
)

BindInt â† FFI!(
  â–¡â‚ƒ âŠƒ(â‹…â‹…Statement~Stmt|âŠ™âŠ™Statement~DB)
  Call â„¤ "sqlite3_bind_int" {C P ğ•§ C â„¤ C â„¤}
  Err!$"Failed to bind integer: _"
)

BindFloat â† FFI!(
  â–¡â‚ƒ âŠƒ(â‹…â‹…Statement~Stmt|âŠ™âŠ™Statement~DB)
  Call â„¤ "sqlite3_bind_double" {C P ğ•§ C â„¤ C â„}
  Err!$"Failed to bind float: _"
)

BindNull â† FFI!(
  â–¡â‚‚ âŠƒ(â‹…Statement~Stmt|âŠ™Statement~DB)
  Call â„¤ "sqlite3_bind_null" {C P ğ•§ C â„¤}
  Err!$"Failed to bind float: _"
)

# ? index text statement
BindText â† FFI!(
  # TODO: This doesn't work, no idea why
  â–¡â‚… âŠƒ(â‹…â‹…Statement~Stmt|âŠ™âˆ˜|Â¯1|NULL|â‹…â‹…Statement~DB)
  Call â„¤ "sqlite3_bind_text" {C P ğ•§ C â„¤ C P ğ•” â„¤ C P ğ•§}
  Err!$"Failed to bind text: _"
)

BindValue â† (
  â—¡â‹…InferType
  â¨¬(ğ„BindNull
  | BindInt
  | BindFloat
  | BindText
  | BindBlob)
)

BindValues â† âˆ§â—‡BindValue +â‚âŠ“Â°âŠÂ¤

# https://www.sqlite.org/c3ref/bind_parameter_index.html"
BindParameterIndex â† FFI!(
  â–¡â‚‚ âŠƒâ¤šâ‹…Statement~Stmt$"Invalid named parameter: \"_\""
  Call â„¤ "sqlite3_bind_parameter_index" {C P ğ•§ C P ğ•”}
  ğ„âŒËœâ¤âŠ¸>â‚€
)

BindNamed â† BindValueâŠ¸â‚‚ğ„BindParameterIndex

BindNamedMap â† âšâŒŸBindNamed Â°map

# https://www.sqlite.org/c3ref/step.html
Step â† FFI!(
  â–¡â‚ Statement~Stmt
  Call â„¤ "sqlite3_step" {C P ğ•§}
)

StepRow â† â‰SqliteRow Step

# https://www.sqlite.org/c3ref/column_count.html
ColumnCount â† FFI!(
  â–¡â‚ Statement~Stmt
  Call â„¤ "sqlite3_column_count" {C P ğ•§}
)

# https://www.sqlite.org/c3ref/column_name.html
ColumnName â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  Call P ğ•” "sqlite3_column_name" {C P ğ•§ C â„¤}
)

# https://www.sqlite.org/c3ref/column_blob.html
# subtract one from the type so they start at 0,
# which makes it easier to use a switch later.
ColumnType â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  -â‚ Call â„¤ "sqlite3_column_type" {C P ğ•§ C â„¤}
)

# https://www.sqlite.org/c3ref/column_blob.html
ColumnBlob â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  # 0â¤."Returning a BLOB is currently unsupported"â—Œ
  # TODO: This doesn't work as expected
  Call P â„¤ "sqlite3_column_blob" {C P ğ•§ C â„¤}
)

# https://www.sqlite.org/c3ref/column_blob.html
ColumnFloat â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  Call â„ "sqlite3_column_double" {C P ğ•§ C â„¤}
)

# https://www.sqlite.org/c3ref/column_blob.html
ColumnInt â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  Call â„¤ "sqlite3_column_int" {C P ğ•§ C â„¤}
)

# https://www.sqlite.org/c3ref/column_blob.html
ColumnText â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  Call P ğ•” "sqlite3_column_text" {C P ğ•§ C â„¤}
)

# Helper function to automatically infer column value and return it
ColumnValue â† (
  â—¡ColumnType
  â¨¬(ColumnInt
  | ColumnFloat
  | ColumnText
  | ColumnBlob
  | NaN)
)

# https://www.sqlite.org/c3ref/finalize.html
Finalize â† FFI!(
  â–¡â‚ Â°Statement
  Call â„¤ "sqlite3_finalize" {C P ğ•§}
  Err!$"Failed to finalize statement: _"
)

ExecuteInsert â† (
  StepâŸœâŠ¸Statement~DB
  â¨¬(â¤.$"Failed to execute insert statement: _" Err|â—Œ)â‰SqliteDone
  Finalize
)

ColumnNames â† âšâŒŸColumnNameâ‡¡âŠ¸ColumnCount

ReadInternal â†š (
  âŸœ(âŠ™[] â‡¡ColumnCount)
  â‹…â—Œâ¢âŸœ(:âŠ‚â¤™âŠ“Â¤âŠ™â—Œ âšâŒŸColumnValueâ¤™âˆ˜)StepRow
)

ReadValues â† FinalizeâŸœReadInternal

ReadMap â† map âŠ™â‰ FinalizeâŸœâŠƒColumnNames ReadInternal
â”Œâ”€â•´Query
  Replace â†š âœâŠœâˆ˜âŠâ‹…âˆ˜ğ„âŒŸâŠ¸â¦·
  RMap â†š Â°âŠŸâ‰[
    {@â†’ "as"}
    {@~ @.}
    {@" @'}
    {@â‰¥ ">="}
    {@â‰¤ "<="}
    {@â‰  "!="}
    {@â "asc"}
    {@â– "desc"}
    {@â§» "count"}
    {"Ã·âŠƒâ§»/+" "avg"}
    {"/+" "sum"}
    {@â†§ "min"}
    {@â†¥ "max"}
    {@âŠ "table"}
    {@âˆ˜ "(*)"}
    {@â‚€ @0}
    {@â‚ @1}
    {@â‚‚ @2}
    {@â‚ƒ @3}
    {@â‚„ @4}
    {@â‚… @5}
    {@â‚† @6}
    {@â‚‡ @7}
    {@â‚ˆ @8}
    {@â‚‰ @9}
  ]

  San â†š (
    Ã—âŠ¸â†»â‚‹â‚â—¿â‚‚\+ â†¥â‚€-â†»â‚‹â‚âŠ¸âˆ©âŒŸ=@\\@"
    /â—‡âŠ‚âŠœ(
      â–¡â—‡â¨¬(
        âˆ§â—‡Replace RMap # apply replacements outside of strings
      | {"\"" "''"}    # unescape double quotes
        {"\\\"" "'"}   # and double single quotes
        âˆ§â—‡Replace      # inside of a string
      )âŠ“âŠ¢â–¡
    )âŠ¸+â‚
  )

  JTMap â†š Â°âŠŸâ‰[
    {"â¬šâŠ‚" "full join"}
    {"Ã—âŠ‚" "cross join"}
    {"âŠ£âŠ‚" "left join"}
    {"âŠ¢âŠ‚" "right join"}
    {"âŠ‚" "inner join"}
  ]
  JType â†š Â°â–¡âŠ¡âŠ—âŠ“â–¡JTMap

  Concat â†š $"_\n_"

  # joined ? join statement-accumulator
  JoinInternal â†š (
    Â°$"_ _ _"
    âŠ“JTypeâŠƒâˆ©San$"âŠ¢â–½âŠ¸âˆŠ _~Fields _~Fields"
    :âŠ™âŸœâ‚‚$$ Â°â–¡â‚‚ âšâŒŸ$"\_.\_" {"_" "_"} _
    ËœConcat$$ "_" "_" "_" _
           $$ $$ from \_
           $$ $$ \_ \_
           $$ $$ on \_ = \_
  )

  # from ? table statement-accumulator
  FromInternal â†š (
    ËœConcat$$ "from _"
  )Â°$"âŠ¡ _"

  # selection ? columns statement-accumulator
  SelectInternal â†š (
    ËœConcat$$ Concat "select _"
  )Â°$"âŠ _"

  # filtered ? condition statement-accumulator
  WhereInternal â†š (
    ËœConcat$$ ËœConcat "where _"
  )Â°$"âŠš _"

  # grouped ? criteria statement-accumulator
  GroupInternal â†š (
    ËœConcat$$ ËœConcat "group by _"
  )Â°$"âŠ•âŠ¸_"

  # filtered-grouped ? condition statement-accumulator
  HavingInternal â†š (
    ËœConcat$$ ËœConcat "having _"
  )Â°$"â–½ _"

  # sorted ? criteria statement-accumulator
  OrderInternal â†š (
    ËœConcat$$ ËœConcat "order by _"
  )Â°$"â† _"

  # limited ? count statement-accumulator
  LimitInternal â†š (
    ËœConcat$$ ËœConcat "limit _"
  )Â°$"â†™ _"

  # limited ? count statement-accumulator
  InsertInternal â†š (
    ËœConcat$$ "insert into _"
  )Â°$"+ _"

  # limited ? count statement-accumulator
  ValuesInternal â†š (
    ËœConcat$$ ËœConcat "values _"
  )Â°$"âš[_]"

  # construct a query
  ! â†^ ËœConcat"ËœâŠ‚@;" âˆ§â—‡â¨¬(
    FromInternal
  | JoinInternal
  | JoinInternal
  | JoinInternal
  | JoinInternal
  | JoinInternal
  | SelectInternal
  | WhereInternal
  | GroupInternal
  | HavingInternal
  | OrderInternal
  | LimitInternal
  | InsertInternal
  | ValuesInternal
  )âŠ¸â‰¡â—‡(âŠ—âŠ“âŠ¢"âŠ¡âŠ‚Ã—âŠ¢âŠ£â¬šâŠâŠšâŠ•â–½â†â†™+âš") âŠ™"" âšSan

  # executes query directly and gets values
  Values! â†^ (
    /$"_|_"
    $$ âœUiqlite~ConnectionâŸœ(
    $$   Uiqlite~ReadValues Uiqlite~Prepare !(_)
    $$ )
  )

  # executes statement
  Exec! â†^ (
    /$"_|_"
    $$ âœUiqlite~ConnectionâŸœ(
    $$   Uiqlite~Exec !(_)
    $$ )
  )
  ExecFmt! â†^ (
    @\W /$"_|_"
    $$ âœUiqlite~ConnectionâŸœ(
    $$   âˆ§â—‡(âœâŠœâˆ˜âŠâ‹…âˆ˜ğ„âŒŸâŠ¸â¦·) âŠ™â¤™âŠ™âŠ™â—Œ â—´âŠ¸âŠœâ–¡âŠ¸â¦·"$_" !(_)
    $$   Uiqlite~Exec
    $$ )
  )

  ValuesFmt! â†^ (
    @\W /$"_|_"
    $$ âœUiqlite~ConnectionâŸœ(
    $$   âˆ§â—‡(âœâŠœâˆ˜âŠâ‹…âˆ˜ğ„âŒŸâŠ¸â¦·) âŠ™â¤™âŠ™âŠ™â—Œ â—´âŠ¸âŠœâ–¡âŠ¸â¦·"$_" !(_)
    $$   Uiqlite~ReadValues Uiqlite~Prepare
    $$ )
  )
â””â”€â•´

# returns all tables in the given database.
# tables ? database
Tables â† âœConnectionâŸœ(
  ReadValues Prepare Query~!(
    âŠ¡ sqlite_schema
  | âŠ name, sql
  | âŠš type = "table"
  )
)

# generates a module from a table and its fields
# module-code ? {name repr}
GenModule â†š $"~_ _" âŠ™(
  âŠœâ–¡âŠ¸â‰ @\n
  âšâ£(âŠ™â—ŒÂ°$"    [_]_")""
  â–½Â±âŠ¸â‰¡â—‡â§»
  $"[_]" /â—‡$"_ _"
) Â°â–¡â‚‚

# generates modules with relevant fields
# for all tables of a given database.
Tables! â†^ â—‡(/$"_\n_" âšGenModule Tables Â°$"\"_\"")âŠ¢
