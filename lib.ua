# Experimental!

â”Œâ”€â•´FFI ~ Call Lib
  LibPath â† "/lib/libsqlite3.so"
  # result ? function params
  Lib â† &ffi âŠ‚â–¡LibPath
  # result ? return-type name param-types params
  Call â† Lib âŠ‚â–¡â‚‚

  P â† $"_*"
  C â† $"const _"

  ð•” â† "char"
  â„ â† "double"
  â„¤ â† "int"
  ð•§ â† "void"
â””â”€â•´

SqliteOk   â† 0
SqliteRow  â† 100
SqliteDone â† 101

~Statement {Stmt DB}

IsNull  â† â‰NaN
IsInt   â† â¨¬0(â‰âŠ¸â…) â†§âˆ©=â‚€âŠ¸âŠƒtype(â§»â–³)
IsFloat â† â¨¬0(Â¬â‰âŠ¸â…) â†§âˆ©=â‚€âŠ¸âŠƒtype(â§»â–³)
IsText  â† â†§âˆ©=â‚âŠƒtype(â§»â–³)
IsBlob  â† â¨¬0(/â†§â‰¤â‚‚â‚…â‚…)â†§âŠ¸âŠƒ(=â‚€type|=â‚â§»â–³)

InferType â† â£(
  âŠ¢âŠš[âŠƒ(IsNull|IsInt|IsFloat|IsText|IsBlob)]
| â¤.$"Invalid value: _"
)

# https://www.sqlite.org/c3ref/errcode.html
Err â† Lib FFI!{C P ð•” "sqlite3_errmsg" C P â„¤} â–¡â‚

Err! â† â¨¬(â¤.^0 Err|â—Œ)â‰SqliteOk

# https://www.sqlite.org/c3ref/open.html
Open â† FFI!(
  âœâ–¡â‚‚(Call â„¤ "sqlite3_open" {C P ð•” P P ð•§}) âŠ™0
  â¤$"Failed to open database: _"â¤™â‰SqliteOk
)

# https://www.sqlite.org/c3ref/close.html
Close â† FFI!(
  Call â„¤ "sqlite3_close" {C P ð•§} â–¡â‚ .
  Err!$"Failed to close database: _"
)

# Should be used like `âœConnectionâŸœF`.
# Inside F, you have access to the database
# pointer. `âŸœ` ensures that the pointer
# ends up on top of the stack to close
# the connection.
Connection â† âŒ…(Open|Close)

# executes a function within a database connection
C! â† âœConnectionâŸœ^0

# https://www.sqlite.org/c3ref/exec.html
Exec â† FFI!(
  â–¡â‚… âŠ“:(0 0 "www")
  Call â„¤ "sqlite3_exec" {C P ð•§ C P ð•” C P ð•§ C P ð•§ C P P ð•”}
  â¨¬(â¤.$"Failed to exec: _"|â—Œ)â‰SqliteOk Â°â–¡â‚‚
)

# https://www.sqlite.org/c3ref/prepare.html
# prepared ? str db*
Prepare â† FFI!(
  â–¡â‚…âŠƒâŠ“:(Â¯1 0 0)â¤™â—Œ
  Call â„¤ "sqlite3_prepare_v2" {C P ð•§ C P ð•” â„¤ P P ð•§ C P P ð•”}
  â¨¬(â¤.$"Failed to prepare statement: _" Err:|âŠ™â—Œ)â‰SqliteOk âˆ©Â°â–¡âŠ¢â‚‚
  Statement
)

# https://www.sqlite.org/c3ref/bind_blob.html
BindBlob â† FFI!(
  # TODO: This doesn't work, no idea why
  â–¡â‚… âŠƒ(â‹…â‹…Statement~Stmt|âŠ™âˆ˜|â‹…â§»|NULL|â‹…â‹…Statement~DB)
  Call â„¤ "sqlite3_bind_blob" {C P ð•§ C â„¤ C P â„¤ C â„¤ C P ð•§}
  Err!$"Failed to bind blob: _"
)

BindInt â† FFI!(
  â–¡â‚ƒ âŠƒ(â‹…â‹…Statement~Stmt|âŠ™âŠ™Statement~DB)
  Call â„¤ "sqlite3_bind_int" {C P ð•§ C â„¤ C â„¤}
  Err!$"Failed to bind integer: _"
)

BindFloat â† FFI!(
  â–¡â‚ƒ âŠƒ(â‹…â‹…Statement~Stmt|âŠ™âŠ™Statement~DB)
  Call â„¤ "sqlite3_bind_double" {C P ð•§ C â„¤ C â„}
  Err!$"Failed to bind float: _"
)

BindNull â† FFI!(
  â–¡â‚‚ âŠƒ(â‹…Statement~Stmt|âŠ™Statement~DB)
  Call â„¤ "sqlite3_bind_null" {C P ð•§ C â„¤}
  Err!$"Failed to bind float: _"
)

# ? index text statement
BindText â† FFI!(
  â–¡â‚… âŠƒ(â‹…â‹…Statement~Stmt|âŠ™âˆ˜|â§»â‹…utfâ‚ˆ|Â¯1|â‹…â‹…Statement~DB)
  Call â„¤ "sqlite3_bind_text" {C P ð•§ C â„¤ C P ð•” â„¤ â„¤}
  Err!$"Failed to bind text: _"
)

BindValue â† (
  â—¡â‹…InferType
  â¨¬(ð„BindNull
  | BindInt
  | BindFloat
  | BindText
  | BindBlob)
)

BindValues â† âšBindValue +â‚âŠ“Â°âŠÂ¤

# https://www.sqlite.org/c3ref/bind_parameter_index.html"
BindParameterIndex â† FFI!(
  â–¡â‚‚ âŠƒâ¤šâ‹…Statement~Stmt$"Invalid named parameter: \"_\""
  Call â„¤ "sqlite3_bind_parameter_index" {C P ð•§ C P ð•”}
  Ëœâ¤â¤š>â‚€
)

BindNamed â† BindValueâŠ¸â‚‚ð„BindParameterIndex

BindNamedMap â† âšâŒŸBindNamed Â°map

# https://www.sqlite.org/c3ref/step.html
Step â† FFI!(
  â–¡â‚ Statement~Stmt
  Call â„¤ "sqlite3_step" {C P ð•§}
)

StepRow â† â‰SqliteRow Step

# https://www.sqlite.org/c3ref/column_count.html
ColumnCount â† FFI!(
  â–¡â‚ Statement~Stmt
  Call â„¤ "sqlite3_column_count" {C P ð•§}
)

# https://www.sqlite.org/c3ref/column_name.html
ColumnName â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  Call P ð•” "sqlite3_column_name" {C P ð•§ C â„¤}
)

# https://www.sqlite.org/c3ref/column_blob.html
# subtract one from the type so they start at 0,
# which makes it easier to use a switch later.
ColumnType â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  -â‚ Call â„¤ "sqlite3_column_type" {C P ð•§ C â„¤}
)

# https://www.sqlite.org/c3ref/column_blob.html
ColumnBlob â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  # 0â¤."Returning a BLOB is currently unsupported"â—Œ
  # TODO: This doesn't work as expected
  Call P â„¤ "sqlite3_column_blob" {C P ð•§ C â„¤}
)

# https://www.sqlite.org/c3ref/column_blob.html
ColumnFloat â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  Call â„ "sqlite3_column_double" {C P ð•§ C â„¤}
)

# https://www.sqlite.org/c3ref/column_blob.html
ColumnInt â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  Call â„¤ "sqlite3_column_int" {C P ð•§ C â„¤}
)

# https://www.sqlite.org/c3ref/column_blob.html
ColumnText â† FFI!(
  â–¡â‚‚â¤šâ‹…Statement~Stmt
  Call P ð•” "sqlite3_column_text" {C P ð•§ C â„¤}
)

# Helper function to automatically infer column value and return it
ColumnValue â† (
  â—¡ColumnType
  â¨¬(ColumnInt
  | ColumnFloat
  | ColumnText
  | ColumnBlob
  | NaN)
)

# https://www.sqlite.org/c3ref/finalize.html
Finalize â† FFI!(
  â–¡â‚ Â°Statement
  Call â„¤ "sqlite3_finalize" {C P ð•§}
  Err!$"Failed to finalize statement: _"
)

ExecuteInsert â† (
  StepâŸœâŠ¸Statement~DB
  â¨¬(â¤.$"Failed to execute insert statement: _" Err|â—Œ)â‰SqliteDone
  Finalize
)

ColumnNames â† âšâŒŸColumnNameâ‡¡âŠ¸ColumnCount

ReadInternal â†š (
  âŸœ(âŠ™[] â‡¡ColumnCount)
  â‹…â—Œâ¢âŸœ(:âŠ‚â¤™âŠ“Â¤âŠ™â—Œ âšâŒŸColumnValueâ¤™âˆ˜)StepRow
)

ReadValues â† FinalizeâŸœReadInternal

ReadMap â† map âŠ™â‰ FinalizeâŸœâŠƒColumnNames ReadInternal

â”Œâ”€â•´Query
  Replace â†š âœâŠœâˆ˜âŠžâ‹…âˆ˜ð„âŒŸâŠ¸â¦·
  RMap â†š Â°âŠŸâ‰[
    {@â†’ "as"}
    {@~ @.}
    {@" @'}
    {@â‰¥ ">="}
    {@â‰¤ "<="}
    {@â‰  "!="}
    {@â "asc"}
    {@â– "desc"}
    {@â§» "count"}
    {"Ã·âŠƒâ§»/+" "avg"}
    {"/+" "sum"}
    {@â†§ "min"}
    {@â†¥ "max"}
    {@âˆ˜ "(*)"}
    {@â‚€ @0}
    {@â‚ @1}
    {@â‚‚ @2}
    {@â‚ƒ @3}
    {@â‚„ @4}
    {@â‚… @5}
    {@â‚† @6}
    {@â‚‡ @7}
    {@â‚ˆ @8}
    {@â‚‰ @9}
  ]

  San â†š (
    â†¥â‚€-â†»â‚‹â‚âŠ¸âˆ©âŒŸ=@\\@"
    Ã—âŠ¸â†»â‚‹â‚â—¿â‚‚\+
    /â—‡âŠ‚âŠœ(
      â–¡â¨¬(
        âˆ§â—‡Replace RMap # apply replacements outside of strings
      | {"\"" "''"}    # unescape double quotes
        {"\\\"" "'"}   # and double single quotes
        âˆ§â—‡Replace      # inside of a string
      )âŠ¢
    )âŠ¸+â‚
  )

  JTMap â†š Â°âŠŸâ‰[
    {"â¬šâŠ‚" "full join"}
    {"âŠžâŠ‚" "cross join"}
    {"âŠ£âŠ‚" "left join"}
    {"âŠ¢âŠ‚" "right join"}
    {"âŠ‚" "inner join"}
  ]
  JType â†š Â°â–¡âŠ¡âŠ—âŠ“â–¡JTMap

  Concat â†š $"_\n_"

  # joined ? join statement-accumulator
  JoinInternal â†š (
    Â°$"_ _ _"
    âŠ“JTypeâ— $"âŠ¢â–½âŠ¸âˆŠ _~Fields _~Fields"
    :âŠ™âŸœâ‚‚$$ Â°â–¡â‚‚ âšâŒŸ$"\_.\_" {"_" "_"} _
    ËœConcat$$ "_" "_" "_" _
           $$ $$ from \_
           $$ $$ \_ \_
           $$ $$ on \_ = \_
  )

  # from ? table statement-accumulator
  FromInternal â†š (
    ËœConcat$$ "from _"
  )Â°$"âŠ¡ _"

  # selection ? columns statement-accumulator
  SelectInternal â†š (
    ËœConcat$$ Concat "select _"
  )Â°$"âŠ _"

  # filtered ? condition statement-accumulator
  WhereInternal â†š (
    ËœConcat$$ ËœConcat "where _"
  )Â°$"âŠš _"

  # grouped ? criteria statement-accumulator
  GroupInternal â†š (
    ËœConcat$$ ËœConcat "group by _"
  )Â°$"âŠ•âŠ¸_"

  # filtered-grouped ? condition statement-accumulator
  HavingInternal â†š (
    ËœConcat$$ ËœConcat "having _"
  )Â°$"â–½ _"

  # sorted ? criteria statement-accumulator
  OrderInternal â†š (
    ËœConcat$$ ËœConcat "order by _"
  )Â°$"â† _"

  # limited ? count statement-accumulator
  LimitInternal â†š (
    ËœConcat$$ ËœConcat "limit _"
  )Â°$"â†™ _"

  # insert ? table statement-accumulator
  InsertInternal â†š (
    ËœConcat$$ "insert into _"
  )Â°$"+ _"

  # w/values ? tuples statement-accumulator
  ValuesInternal â†š (
    ËœConcat$$ ËœConcat "values _"
  )Â°$"âš[_]"

  # construct a query
  ! â†^ ËœConcat"ËœâŠ‚@;" âˆ§â—‡â¨¬(
    FromInternal
  | JoinInternal
  | JoinInternal
  | JoinInternal
  | JoinInternal
  | JoinInternal
  | SelectInternal
  | WhereInternal
  | GroupInternal
  | HavingInternal
  | OrderInternal
  | LimitInternal
  | InsertInternal
  | ValuesInternal
  )âŠ¸â‰¡â—‡(âŠ—âŠ“âŠ¢"âŠ¡âŠ‚Ã—âŠ¢âŠ£â¬šâŠâŠšâŠ•â–½â†â†™+âš") âŠ™"" âšSan
â””â”€â•´

# executes a query directly and gets values
Values! â†^ $"ReadValues Prepare Query~!(_)" /$"_|_"

# formats given values, executes query and
# returns its resulting values
ValuesFmt! â†^ (
  /$"_|_"
  $$ Prepare Query~!(_)
  $$ ReadValues BindValuesâ¤š:
)

# executes a query directly and gets values as a map
Map! â†^ $"ReadMap Prepare Query~!(_)" /$"_|_"

# formats given values, executes query and
# returns its resulting values as a map
MapFmt! â†^ (
  /$"_|_"
  $$ Prepare Query~!(_)
  $$ ReadMap BindValuesâ¤š:
)

# executes a statement in one fell swoop
Exec! â†^ $"Exec Query~!(_)" /$"_|_"

# formats given values into statement and executes it
ExecFmt! â†^ (
  /$"_|_"
  $$ Prepare Query~!(_)
  $$ â—ŒâŠƒFinalize Step BindValuesâ¤š:
)

# returns all tables in the given database,
# as name-code-pairs.
# tables ? database
Tables â† âœConnectionâŸœ(
  ReadValues Prepare Query~!(
    âŠ¡ sqlite_schema
  | âŠ name, sql
  | âŠš type = "table"
  )
)

# generates a module from a table and its fields
# module-def ? {name repr}
GenModule â†š $"~_ _" âŠ™(
  âŠœâ–¡âŠ¸â‰ @\n
  âšâ£(âŠ™â—ŒÂ°$"    [_]_")""
  â–½Â±âŠ¸â‰¡â—‡â§»
  $"[_]" /â—‡$"_ _"
) Â°â–¡â‚‚

# generates modules with relevant fields
# for all tables of a given database.
Tables! â†^ â—‡(/$"_\n_" âšGenModule Tables Â°$"\"_\"")âŠ¢
