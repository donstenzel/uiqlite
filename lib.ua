# Experimental!

â”Œâ”€â•´FFI ~ Call Lib
  LibPath â† "/lib/libsqlite3.so"
  # result ? function params
  Lib â† &ffi âŠ‚â–¡LibPath
  # result ? return-type name param-types params
  Call â† Lib âŠ‚â–¡â‚‚

  Out â† $"out _"

  Double â† "double"
  Int    â† "int"
  Str    â† "char*"
  DB     â† "ulong"
  Stmt   â† "ulong"
â””â”€â•´

SqliteOk   â† 0
SqliteRow  â† 100
SqliteDone â† 101

# [TODO]: this can probably be simplified

IsNull  â† â‰NaN
IsInt   â† â¨¬0(â‰âŠ¸â…) â†§âˆ©=â‚€âŠ¸âŠƒtype(â§»â–³)
IsFloat â† â¨¬0(Â¬â‰âŠ¸â…) â†§âˆ©=â‚€âŠ¸âŠƒtype(â§»â–³)
IsText  â† â†§âˆ©=â‚âŠƒtype(â§»â–³)
IsBlob  â† â¨¬0(/â†§â‰¤â‚‚â‚…â‚…)â†§âŠ¸âŠƒ(=â‚€type|=â‚â§»â–³)

InferType â† â£(
  âŠ¢âŠšâŠƒ[IsNull|IsInt|IsFloat|IsText|IsBlob]
| â¤âŠ™0 $"Invalid value: _"
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/errcode.html)
# msg ? db
Err â† FFI!(Call Str "sqlite3_errmsg" {DB} â–¡â‚)

Err! â† â¤^â¤šâ‹…Errâ‰SqliteOk

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/open.html)
# db ? path
Open â† FFI!(
  âœâ–¡â‚‚(Call Int "sqlite3_open" {Str Out DB}) âŠ™0
  âŠ¸Err!$"Failed to open database: _"
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/close.html)
# ? db
Close â† FFI!(
  Call Int "sqlite3_close" {DB}âŠ¸â–¡â‚
  Err!$"Failed to close database: _"
)

# Should be used like `âœConnection F`.
# Inside F, you have access to the database
# pointer.
Connection â† âŒ…(Open|.Open|Close)

# executes a function within a database connection.
# the database pointer will be pushed to the stack.
C! â† âœConnection^0

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/exec.html)
# Track caller!
# ? sql db
Exec â† FFI!(
  â–¡â‚…âŠ¸âŠ“:âˆ©â‚ƒNULL
  Call Int "sqlite3_exec" {DB Str "void*" "void*" Str}
  Err!$"Failed to execute: _"
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/prepare.html)
# Track caller!
# stmt ? str db
Prepare â† FFI!(
  â–¡â‚…âŠ¸âŠ“:(Â¯1 0 NULL)
  Call Int "sqlite3_prepare_v2" {DB Str Int Out Stmt Str}
  ğ„âŒErr!$"Failed to prepare statement: _" Â°â–¡â‚‚
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/bind_blob.html)
# ? idx bytes stmt db
BindBlob â† FFI!(
  â–¡â‚„ âŠƒâ¤™âŠ™âŠ™â—ŒÂ¯1
  Call Int "sqlite3_bind_blob" {Stmt Int "byte:3" Int Int}
  Err!$"Failed to bind blob: _"
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/bind_blob.html)
# ? idx int stmt db
BindInt â† FFI!(
  Call Int "sqlite3_bind_int" {Stmt Int Int} â–¡â‚ƒâ¤™âŠ™âŠ™â—Œ
  Err!$"Failed to bind integer: _"
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/bind_blob.html)
# ? idx num stmt db
BindFloat â† FFI!(
  Call Int "sqlite3_bind_double" {Stmt Int Double} â–¡â‚ƒâ¤™âŠ™âŠ™â—Œ
  Err!$"Failed to bind float: _"
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/bind_blob.html)
# ? idx stmt db
BindNull â† FFI!(
  Call Int "sqlite3_bind_null" {Stmt Int} Ëœâ–¡â‚‚
  Err!$"Failed to bind null: _"
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/bind_blob.html)
# ? idx text stmt db
BindText â† FFI!(
  â–¡â‚… âŠƒâ¤™âŠ™âŠ™â—ŒâŠƒ(â§»â‹…utfâ‚ˆ)Â¯1
  Call Int "sqlite3_bind_text" {Stmt Int Str Int Int}
  Err!$"Failed to bind text: _"
)

# binds a value to the parameter with the given index
# ? idx value stmt db
BindValue â† (
  â¨¬(ğ„BindNull|BindInt|BindFloat|BindText|BindBlob)â—¡â‹…InferType
)

# binds values to parameters equal to
# their index +1, so binding {"Foo" "Bar" "Baz"}
# would bind to parameter 1, 2 and 3, respectively.
# Track caller!
# ? stmt values db
BindValues â† âšBindValue +â‚Â°âŠ :

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/bind_parameter_index.html")
# idx ? name stmt
GetParameterIndex â† FFI!(
  Call Int "sqlite3_bind_parameter_index" {Stmt Str} â–¡â‚‚ â¤š:
  Ëœâ¤â¤šâŠ“â‰ â‚€$"Invalid named parameter: '_'"
)

# binds a value to the parameter with the given name
# ? name value stmt db
BindNamed â† BindValueâŠ¸ğ„âŒŸGetParameterIndex

# binds values inside a map from parameter name to value
# ? map stmt db
BindNamedMap â† âšBindNamed Â°map

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/step.html)
# code ? stmt
Step â† FFI!(
  Call Int "sqlite3_step" {Stmt} â–¡â‚
)

# [TODO]: rework this for other codes?
# isRow ? stmt
StepRow â† â‰SqliteRow Step

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/column_count.html)
# cols ? stmt
ColumnCount â† FFI!(
  Call Int "sqlite3_column_count" {DB} â–¡â‚
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/column_name.html)
# name ? idx stmt
ColumnName â† FFI!(
  Call Str "sqlite3_column_name" {Stmt Int} Ëœâ–¡â‚‚
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/column_blob.html)
# subtracts one from the type so they start at 0,
# which makes it easier to use a switch later.
# type ? idx stmt
ColumnType â† FFI!(
  -â‚ Call Int "sqlite3_column_type" {Stmt Int} Ëœâ–¡â‚‚
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/column_blob.html)
# blob ? idx stmt
ColumnBlob â† FFI!(
  &memcpyâŠƒ(
    Call "byte*" "sqlite3_column_blob" {Stmt Int} Ëœâ–¡â‚‚
  | Call Int "sqlite3_column_bytes" {Stmt Int} Ëœâ–¡â‚‚
  )
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/column_blob.html)
# num ? idx stmt
ColumnFloat â† FFI!(
  Call Double "sqlite3_column_double" {Stmt Int} Ëœâ–¡â‚‚
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/column_blob.html)
# int ? idx stmt
ColumnInt â† FFI!(
  Call Int "sqlite3_column_int" {Stmt Int} Ëœâ–¡â‚‚
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/column_blob.html)
# text ? idx stmt
ColumnText â† FFI!(
  Call Str "sqlite3_column_text" {Stmt Int} Ëœâ–¡â‚‚
)

# Helper function to automatically infer column type and return value
# value ? idx stmt
ColumnValue â† (
  â¨¬(ColumnInt|ColumnFloat|ColumnText|ColumnBlob|NaN)â—¡ColumnType
)

# [SQLite3 Documentation](https://www.sqlite.org/c3ref/finalize.html)
# ? stmt db
Finalize â† FFI!(
  Call Int "sqlite3_finalize" {Stmt} â–¡â‚
  Err!$"Failed to finalize statement: _"
)

# Track caller!
# ? stmt db
ExecStmt â† (
  â¤šâ‹…Err â‰SqliteDoneâŠ¸âŠƒFinalize Step
  â¤$"Failed to execute statement: _"
)

# names ? stmt
ColumnNames â† âšColumnNameâ‡¡âŠ¸ColumnCount

# row ? stmt
ReadRow â† âšColumnValueâ‡¡âŠ¸ColumnCount

# values ? stmt
ReadInternal â† â¢âŸœReadRow StepRow

# values ? stmt db
ReadValues â† âŠƒFinalize ReadInternal

# map ? stmt db
ReadMap â† mapâŠ™â‰âŠƒFinalizeâŠƒColumnNames ReadInternal

â”Œâ•¶â•¶Query
  # [TODO]: more keywords / replacements
  (/$"_\n_"âš$"_ â† ")^!(
    INSERT | INTO | HAVING | SELECT | GROUP | INNER
  | LIMIT | ORDER | WHERE | COUNT | DESC | FROM
  | JOIN | ASC | SUM | AS | BY | ON | VALUES | CREATE
  | TABLE | INTEGER | NOT | NULL | FOREIGN | KEY
  | REFERENCES | PRIMARY | NVARCHAR
  )

  RMap    â† Â°âŠŸâ‰[{@. @;} {@~ @.} {@: @,} {@Ã— @*} {@â‰¤ "<="} {@â‰¥ ">="}]
  Replace â†š âœâŠœâˆ˜âŠâ‹…âˆ˜ğ„âŒŸâŠ¸â¦·

  ! â†^ âŠ‚"$ " âŠ‚âŠ™@; â¥â‹…@\sâŠ¸=@\n âˆ§â—‡Replace RMap âŠ“Â°â–¡â‚â—Œ
â””â•¶â•¶

# allows the creation of SQL queries in unquoted code
# which will check for all tables/fields existing as
# Uiua functions (the intended use is in combination
# with the `Database!` macro). Some characters get replaced,
# since the Uiua formatter replaces them originally,
# like `Ã—` -> `*`
Q! â† Query!(!^)

# executes a query and returns values
# Track caller!
# values ? sql db
Values â† ReadValuesâŠ¸Prepare

# executes a query and returns values
# as a map from column names to values
# Track caller!
# map ? sql db
Map â† ReadMapâŠ¸Prepare

# executes a query with parameters, returns values
# Track caller!
# values ? sql params db
PValues â† ReadValuesâŸœâŠ¸BindValuesâŠ¸ğ„âŒŸPrepare

# executes a query with parameters, returns values
# as a map from column names to values
# Track caller!
# map ? sql params db
PMap â† ReadMapâŸœâŠ¸BindValuesâŠ¸ğ„âŒŸPrepare

# executes a query with parameters directly
# Track caller!
# ? sql params db
PExec â† ExecStmtâŸœâŠ¸BindValuesâŠ¸ğ„âŒŸPrepare

# returns all tables in the given database,
# as name-code-pairs.
# tables ? database
Tables â† âœConnection(
  Values $ SELECT Name, SQL
         $ FROM sqlite_schema
         $ WHERE type = 'table';
)

# [TODO]: generated modules should have validators for data types
# and support much more syntax

# generates a module from a table and its fields
# module ? table
GenModule â†š $"~_ {_}" âŠ™(
  âŠœâ–¡âŠ¸â‰ @\n
  âšâ£(âŠ™â—ŒÂ°$"    [_]_")""
  /$"_ _" â–½Â±âŠ¸â‰¡â—‡â§»
) Â°â–¡â‚‚

F â† (
  âœâŠœâ–¡âšâ‹…@\sâŠ¸âˆŠ"\s\n\t" # normalize spaces
  Â°$"CREATE TABLE [_] ( _ )"
)

# generates modules with relevant fields
# for all tables of a given database.
Database! â†^ /$"_\n_" âšGenModule Tables Â°$"\"_\"" Â°â–¡â‚
